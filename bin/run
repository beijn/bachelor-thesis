#!/bin/bash
#SBATCH -J ipynb
#SBATCH -t 06:59:00
#SBATCH --ntasks=1
#SBATCH --mem=40G
#SBATCH --cpus-per-task=10
#SBATCH --partition=gpu
#SBATCH --gres=gpu:tesla:1
#SBATCH --mail-user=benjamin.eckhardt@ut.ee
#SBATCH -o runs/%j.out # STDOUT


STARTTIME="$(date +%y%m%d-%H%M%S)"
FILE="$1"
TAG="$2"
NAME="$(basename "$FILE" .py)"
SUBDIR="$(dirname "$FILE")"   # NOTE this is designed to run relative to ~/thesis
if [ "$SUBDIR" = "" ]; then SUBDIR="."; fi
ENV="$(basename "$SUBDIR")"
if [ "$SUBDIR" = "." ]; then ENV='thesis'; fi
OUTDIR="./runs/$SUBDIR/$NAME"
WORKING="$SUBDIR/$(sha1sum "$FILE" | cut -c-9).ipynb"

mkdir -p "$OUTDIR"


echo; echo; echo "  ===  RUNNING  $FILE  ===  "; echo


micromamba shell init --shell=bash --prefix=~/.micromamba   >/dev/null
eval "$(micromamba shell hook --shell=bash)"                >/dev/null
micromamba activate "$ENV"                                  >/dev/null


SECONDS=0
jupytext --to notebook --execute -o "$WORKING" "$FILE"

duration="$SECONDS"
RUNTIME="$(date -ud "@$duration" +%H%M%S)"
echo; echo "Notebook execution time $RUNTIME (HHMMSS)"

RESULT="$OUTDIR/$STARTTIME-$RUNTIME"
if [ $# = 2 ]; then
  RESULT="$RESULT-$2"; fi
RESULT="$RESULT.ipynb"

mv "$WORKING" "$RESULT"

echo "Saved to $RESULT"